<!DOCTYPE HTML>
<!--
	Industrious by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>

<head>
    <title>RESTful API usage limitations discoverer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/js/monaco/min/vs/editor/editor.main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
</head>

<body class="is-preload">

    <!-- Header -->
    <header id="header">
        <a class="logo" href="index.html">RESTful API usage limitations discoverer</a>
        <nav>
            <a href="#menu">Menu</a>
        </nav>
    </header>

    <!-- Nav -->
    <nav id="menu">
        <ul class="links">
            <!-- <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                <a href="editor.html">Editor</a>
            </li> -->
            <li>
                <a href="index.html">Editor</a>
            </li> -->
        </ul>
    </nav>

    <!-- Heading -->
    <div id="heading">
        <h1>RESTful API usage limitations discoverer</h1>
    </div>

    <!-- Main -->
    <section id="main" class="wrapper">
        <div class="inner">
            <div class="content">

                <div id="graphcontainer"></div>

                <!-- Elements -->
                <div class="row">
                    <div class="col-5 col-12-medium">
                        <h3>Actions</h3>
                        <ul class="actions">
                            <li>
                                <a href="#main" title="You should save the model before running this operation" class="button primary" onclick="exec();">Calculate usage limitations</a>
                            </li>
                            <li>
                                <a href="#main" title="This operation will also save the model" class="button" onclick="saveMapping();">Refresh graph</a>
                            </li>
                            <li>
                                <a href="#mappingEditor" class="button" onclick="loadData();">Refresh editor</a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-3 col-12-medium">
                        <h3>Examples</h3>
                        <ul class="actions">
                            <li>
                                <a href="#main" class="button" onclick="change('mapping-simple')">Simple</a>
                            </li>
                            <li>
                                <a href="#main" class="button" onclick="change('mapping-complex')">Complex</a>
                            </li>

                        </ul>
                    </div>
                    <div class="col-3 col-12-medium">
                        <h3>CSOP mapping</h3>
                        <ul class="actions">
                            <!-- <li>
                                <a href="#main" class="button" >Simple</a>
                            </li> -->
                            <li>
                                <a href="data/mapping-simple.mzn" target="_blank" class="button">Simple</a>
                            </li>
                            <li>
                                <a href="data/mapping-complex.mzn" target="_blank" class="button">Complex</a>
                            </li>

                        </ul>
                    </div>
                    <div class="col-1 col-12-medium">
                        <h3>RESTalk</h3>
                        <ul class="actions">
                            <!-- <li>
                                <a href="#main" class="button" >Simple</a>
                            </li> -->
                            <li>
                                <a href="data/restalk-complex.pdf" target="_blank" class="button">Complex</a>
                            </li>

                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-12-medium">
                        <h3>Dependencies graph</h3>
                        <img src="" id="graphcontainerImg" width="100%">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-12-medium">
                        <h3>Editor actions</h3>
                        <ul class="actions">
                            <li>
                                <a href="#mappingEditor" class="button primary" onclick="saveMapping();">Save</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-12-medium">
                        <h3>Editor</h3>

                        <div class="tab">
                            <button class="tablinks" onclick="openTab(event, 'mappingEditorTab')">Mapping</button>
                            <button class="tablinks" onclick="openTab(event, 'oasEditorTab')">OAS</button>
                            <button class="tablinks" onclick="openTab(event, 'sla4oaiEditorTab')">SLA4OAI</button>
                        </div>

                        <select id="serviceSelector" onchange="loadServiceModels(this);">
                            <option>Select a service</option>
                        </select>

                        <div id="mappingEditorTab" class="tabcontent">
                            <div id="mappingEditor" style="width:100%;height:600px;border:1px solid grey"></div>
                        </div>

                        <div id="oasEditorTab" class="tabcontent" style="visibility: hidden;">
                            <div id="oasEditor" style="width:100%;height:600px;border:1px solid grey;"></div>
                        </div>

                        <div id="sla4oaiEditorTab" class="tabcontent" style="visibility: hidden">
                            <div id="sla4oaiEditor" style="width:100%;height:600px;border:1px solid grey;"></div>
                        </div>


                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-12-medium">
                        <h3>Editor actions</h3>
                        <ul class="actions">
                            <li>
                                <a href="#mappingEditor" class="button primary" onclick="saveMapping();">Save</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="footer">
        <div class="inner">
            <div class="content">
                <section>
                    <h3>About us</h3>
                    <p>We are...</p>
                </section>
                <section>
                    <h4>More information</h4>
                    <ul class="alt">
                        <li>
                            <a href="https://isa-group.github.io/2018-06-comprehensive-modeling/">Comprehensive API modeling</a>
                        </li>
                        <li>
                            <a href="http://restalk-patterns.org/rest.html">RESTalk patterns</a>
                        </li>
                    </ul>
                </section>
                <section>
                    <h4>Contact</h4>
                    <ul class="plain">
                        <li>
                            <a href="#main">
                                <i class="icon fa-twitter">&nbsp;</i>@someone</a>
                        </li>
                        <li>
                            <a href="#main">
                                <i class="icon fa-twitter">&nbsp;</i>@someone</a>
                        </li>
                        <li>
                            <a href="#main">
                                <i class="icon fa-github">&nbsp;</i>Github</a>
                        </li>
                    </ul>
                </section>
            </div>
            <div class="copyright">
                &copy;
            </div>
        </div>
    </footer>



    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.parsers.json.min.js"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <!-- <script>
        sigma.parsers.json('data/data.json', {
            container: 'graphcontainer',
            settings: {
                defaultNodeColor: '#ec5148'
            }
        });
    </script> -->

    <script>
        if (!localStorage.getItem('mapping')) {
            localStorage.setItem('mapping', "mapping-simple");
        }
        document.getElementById('graphcontainerImg').src = 'data/' + localStorage.getItem('mapping') + '.png';

        var require = {
            paths: {
                'vs': 'assets/js/monaco/min/vs'
            }
        };
    </script>
    <script src="assets/js/monaco/min/vs/loader.js"></script>
    <script src="assets/js/monaco/min/vs/editor/editor.main.nls.js"></script>
    <script src="assets/js/monaco/min/vs/editor/editor.main.js"></script>

    <script>
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": false,
            "progressBar": true,
            "positionClass": "toast-bottom-full-width",
            "preventDuplicates": true,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }


        $.get('data/' + localStorage.getItem('mapping') + '.yaml', function (data) {
            var mappingEditorHTML = document.getElementById('mappingEditor');
            var oasEditorHTML = document.getElementById('oasEditor');
            var sla4oaiEditorHTML = document.getElementById('sla4oaiEditor');

            var editor = monaco.editor.create(mappingEditorHTML, {
                value: data,
                language: 'yaml'
            });
            var oasEditor = monaco.editor.create(oasEditorHTML, {
                value: "Select a service",
                language: 'yaml',
                readOnly: true
            });
            var sla4oaiEditor = monaco.editor.create(sla4oaiEditorHTML, {
                value: "Select a service",
                language: 'yaml',
                readOnly: true
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, function () {
                saveMapping();
            });
            editor.addAction({
                id: 'refresh',
                label: 'Refresh document',
                precondition: null,
                keybindingContext: null,
                contextMenuGroupId: 'navigation',
                contextMenuOrder: 1.5,
                run: loadData
            });
            editor.addAction({
                id: 'save',
                label: 'Save document',
                precondition: null,
                keybindingContext: null,
                contextMenuGroupId: 'navigation',
                contextMenuOrder: 1.5,
                run: saveMapping
            });
            editor.addAction({
                id: 'exec',
                label: 'Calculate usage limitations',
                precondition: null,
                keybindingContext: null,
                contextMenuGroupId: 'navigation',
                contextMenuOrder: 1.5,
                run: exec
            });


            var svc = jsyaml.safeLoad(monaco.editor.getModels()[0].getValue()).services;
            var serviceSelector = document.getElementById("serviceSelector");
            Object.entries(svc).forEach(function ([name, path]) {
                var opt = document.createElement("option");
                opt.text = name;
                opt.value = path;
                serviceSelector.options.add(opt);
            });
        });


        function loadData() {
            $.get('data/' + localStorage.getItem('mapping') + '.yaml', function (data) {
                //data is the JSON string
                monaco.editor.getModels()[0].setValue(data);
            });
        }

        function saveMapping() {
            var text = monaco.editor.getModels()[0].getValue();
            $.ajax({
                type: "POST",
                url: "postMapping?mapping=" + localStorage.getItem('mapping'),
                data: jsyaml.safeLoad(text),
                success: function () {
                    console.log("OK saved");
                    window.location.replace("generate?mzn=true&dot=true&mapping=" + localStorage.getItem(
                        'mapping'));
                }
            });
        }

        // function saveOAS() {
        //     var text = monaco.editor.getModels()[1].getValue();
        //     $.ajax({
        //         type: "POST",
        //         url: "postOAS?service=algo&mapping=" + localStorage.getItem('mapping'),
        //         data: jsyaml.safeLoad(text),
        //         success: function () {
        //             console.log("OK saved");
        //             window.location.replace("generate?mzn=true&dot=true&mapping=" + localStorage.getItem(
        //                 'mapping'));
        //         }
        //     });
        // }
        // function saveOAS() {
        //     var text = monaco.editor.getModels()[2].getValue();
        //     $.ajax({
        //         type: "POST",
        //         url: "postSLA4OAI?service=algo&mapping=" + localStorage.getItem('mapping'),
        //         data: jsyaml.safeLoad(text),
        //         success: function () {
        //             console.log("OK saved");
        //             window.location.replace("generate?mzn=true&dot=true&mapping=" + localStorage.getItem(
        //                 'mapping'));
        //         }
        //     });
        // }

        function exec() {
            $.ajax({
                type: "GET",
                url: "exec?mapping=" + localStorage.getItem('mapping'),
                success: function (data) {
                    toastr["info"](data, "Usage limitations")
                }
            });
        }

        function change(name) {
            localStorage.setItem('mapping', name);
            window.location.replace('generate?mzn=true&dot=true&mapping=' + localStorage.getItem('mapping'));
        }

        function openTab(event, idTab) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(idTab).style.display = "block";
            document.getElementById(idTab).style.visibility = "initial";
            event.currentTarget.className += " active";
        }

        function loadServiceModels(select) {
            var svc = select.value;
            $.get(svc, function (oas) {
                monaco.editor.getModels()[1].setValue(oas);
                var sla = jsyaml.safeLoad(oas).info['x-sla'];
                if (sla) {
                    $.get(sla, function (sla4oai) {
                        monaco.editor.getModels()[2].setValue(sla4oai);
                    });
                } else {
                    monaco.editor.getModels()[2].setValue("No SLA4OAI for this service");
                }

            });
        }

    </script>

</body>

</html>